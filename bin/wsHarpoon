#!/bin/bash

HARPFILE="/home/oleete/.config/wsHarpoon"
HARPFOLDER="/home/oleete/.config/Harpoon"
XMONADCTL="/home/oleete/.cabal/bin/xmonadctl-exe"

main () {
    case ${1:-menu} in
        menu)       menu ;;
        moveMenu)   moveMenu ;;
        goMoveMenu) goMoveMenu ;;
        add)        addWS ;;
        modify)     modifyWS ;;
        jump)       jumpToWS "$2" ;;
        move)       moveToWS "$2" ;;
        preset)     preset "$2" ;;
        makePreset) makePreset ;;
        closeWSMenu) closeWSMenu ;;
    esac
}

menu () {
    items="$(wmctrl -d | awk '{print $9}')"
    result=$((for item in $items; do echo $item; done) | rofi -matching fuzzy -window-title "Menu" -dmenu "Menu" -i)
    if [ ! -z "$result" ]; then
        WS="$(wmctrl -d | rg -w "$result" | awk '{print $1}')"
        $XMONADCTL jump-to-"$WS"
    fi
}

moveMenu () {
    items="$(wmctrl -d | awk '{print $9}')"
    result=$((for item in $items; do echo $item; done) | rofi -matching fuzzy -window-title "Menu" -dmenu "Menu" -i)
    if [ ! -z "$result" ]; then
        WS="$(wmctrl -d | rg -w "$result" | awk '{print $1}')"
        $XMONADCTL move-to-"$WS"
    fi
}

goMoveMenu () {
    items="$(wmctrl -d | awk '{print $9}')"
    result=$((for item in $items; do echo $item; done) | rofi -matching fuzzy -window-title "Menu" -dmenu "Menu" -i)
    if [ ! -z "$result" ]; then
        WS="$(wmctrl -d | rg -w "$result" | awk '{print $1}')"
        $XMONADCTL move-to-"$WS"
        $XMONADCTL jump-to-"$WS"
    fi
}

modifyWS () {
    alacritty --class wsHarpoon -t 'System Monitor' -e "nvim" +"nnoremap <esc> :wq<cr>|nnoremap q :wq<cr>" "$HARPFILE"
}

addWS () {
    WSnum="$(wmctrl -d | grep '*' | awk '{print $1}')"
    WSname="$(wmctrl -d | grep '*' | awk '{print $9}' | sed 's/ /-/')"
    if ! rg -q "$WSname" "$HARPFILE"; then
        echo "$WSnum" "$WSname" >> "$HARPFILE"
    fi
}

preset () {
    FILE=$((for item in "$HARPFOLDER"/*; do echo $(basename $item); done) | rofi -matching fuzzy -window-title "Workspace Presets" -dmenu "WorkspacePresets")
    cat "$HARPFOLDER/$FILE" > "$HARPFILE"
    jumpToWS 1
}

makePreset () {
    NAME=$((for item in "$HARPFOLDER"/*; do echo $(basename $item); done) | rofi -matching fuzzy -window-title "Make Preset" -dmenu "Make Preset")
    if [ ! -z "$NAME" ]; then
        cat "$HARPFILE" > "$HARPFOLDER/$NAME"
    fi
}

jumpToWS () {
    if [[ $(wc -l <"$HARPFILE") -ge $1 ]]; then
        WS="$(cat "$HARPFILE" | head -"$1" | tail -1 | awk '{print $1}')"
        $XMONADCTL jump-to-"$WS"
    fi
}

moveToWS () {
    WS="$(cat "$HARPFILE" | head -"$1" | tail -1 | awk '{print $1}')"
    $XMONADCTL move-to-"$WS"
}

closeWSMenu () {
    wsNum="$(wmctrl -l | awk '{print $2}' | uniq)"
    items=$(for item in $wsNum; do wmctrl -d | rg -e "^$item" | awk '{print $9}'; done)
    result=$((for item in $items; do echo $item; done) | rofi -matching fuzzy -window-title "Menu" -dmenu "Menu" -i)
    if [ ! -z "$result" ]; then
        wsNum=$(wmctrl -d | rg -e "$result$" | rg -o -e "^\d*")
        for item in $(wmctrl -l | rg $wsNum | awk '{print $1}'); do 
            wmctrl -i -c $item
        done
        sleep 0.5
        closeWSMenu
    fi
}

main "$@"
