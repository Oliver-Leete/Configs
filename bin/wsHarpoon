#!/bin/bash

HARPFILE="/home/oleete/.config/wsHarpoon"
HARPFOLDER="/home/oleete/.config/Harpoon"
XMONADCTL="/home/oleete/.cabal/bin/xmonadctl-exe"

main () {
    case ${1:-menu} in
        jump)         jumpToWS "$2"     ;;
        move)         moveToWS "$2"     ;;
        add)          addWS             ;;
        modify)       modifyWS          ;;
        selectPreset) selectPreset "$2" ;;
        makePreset)   makePreset        ;;
        modfiyPreset) modfiyPreset      ;;
        mainMenu)     mainMenu          ;;
    esac
}

jumpToWS () {
    WS="$(cat "$HARPFILE" | head -"$1" | tail -1 | awk '{print $1}')"
    WS="$(wmctrl -d | rg -w "$WS" | awk '{print $1}')"
    "$XMONADCTL" jump-to-"$WS"
}

moveToWS () {
    WS="$(cat "$HARPFILE" | head -"$1" | tail -1 | awk '{print $1}')"
    WS="$(wmctrl -d | rg -w "$WS" | awk '{print $1}')"
    "$XMONADCTL" move-to-"$WS"
}

addWS () {
    WSname="$(wmctrl -d | grep '*' | awk '{print $9}' | sed 's/ /-/')"
    if ! rg -q "$WSname" "$HARPFILE"; then
        echo "$WSname" >> "$HARPFILE"
    fi
}

modifyWS () {
    alacritty --class wsHarpoon -t 'System Monitor' -e "nvim" +"nnoremap <esc> :wq<cr>|nnoremap q :wq<cr>" "$HARPFILE"
}

selectPreset () {
    FILE=$((for item in "$HARPFOLDER"/*; do echo $(basename "$item"); done) | rofi -matching fuzzy -window-title "Workspace Presets" -dmenu "WorkspacePresets")
    cat "$HARPFOLDER/$FILE" > "$HARPFILE"
    jumpToWS 1
}

makePreset () {
    NAME=$((for item in "$HARPFOLDER"/*; do echo $(basename "$item"); done) | rofi -matching fuzzy -window-title "Make Preset" -dmenu "Make Preset")
    if [ ! -z "$NAME" ]; then
        cat "$HARPFILE" > "$HARPFOLDER/$NAME"
    fi
}

modifyPreset () {
    FILE=$((for item in "$HARPFOLDER"/*; do echo $(basename "$item"); done) | rofi -matching fuzzy -window-title "Workspace Presets" -dmenu "WorkspacePresets")
    if [ ! -z "$FILE" ]; then
        alacritty --class wsHarpoon -t 'System Monitor' -e "nvim" +"nnoremap <esc> :wq<cr>|nnoremap q :wq<cr>" "$HARPFOLDER/$FILE"
    fi
}

mainMenu () {
    items="add $(wmctrl -d | awk '{print $9}') modify presets make-preset modify-preset"
    result=$((for item in $items; do echo $item; done) | rofi -matching fuzzy -window-title "Menu" -dmenu "Menu" -i)
    if [[ $result == "add" ]]; then
        addWS
    elif [[ $result == "modify" ]]; then
        modifyWS
    elif [[ $result == "presets" ]]; then
        selectPreset
    elif [[ $result == "make-preset" ]]; then
        makePreset
    elif [[ $result == "modify-preset" ]]; then
        modifyPreset
    elif [[ ! -z "$result" && "$items" == *"$result"* ]]; then
        actions="goto move-to go-and-move add-to-preset close"
        mode=$((for action in $actions; do echo $action; done) | rofi -matching fuzzy -window-title "$result" -dmenu "$result" -i)
        if [[ $mode == "goto" ]]; then
            WS="$(wmctrl -d | rg -w "$result" | awk '{print $1}')"
            "$XMONADCTL" jump-to-"$WS"
        elif [[ $mode == "move-to" ]]; then
            WS="$(wmctrl -d | rg -w "$result" | awk '{print $1}')"
            "$XMONADCTL" move-to-"$WS"
        elif [[ $mode == "go-and-move" ]]; then
            WS="$(wmctrl -d | rg -w "$result" | awk '{print $1}')"
            "$XMONADCTL" move-to-"$WS"
            "$XMONADCTL" jump-to-"$WS"
        elif [[ $mode == "close" ]]; then
            wsNum="$(wmctrl -d | rg -w "$result" | awk '{print $1}')"
            wmctrl -l | rg -e "^\S+\s+$wsNum" | awk '{print $1}' | xargs -n1 wmctrl -i -c
            mainMenu
        elif [[ $mode == "add-to-preset" ]]; then
            if ! rg -q "$result" "$HARPFILE"; then
                echo "$result" >> "$HARPFILE"
            fi
        fi
    elif [[ ! -z "$result" ]]; then
        notify-send "Invalid Project"
    fi

}

main "$@"
